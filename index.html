<!DOCTYPE html>

<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAU/USD PRO - Commercial Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        color: #333;
        padding: 20px;
        min-height: 100vh;
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
    }

    .header {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(255, 215, 0, 0.3);
        margin-bottom: 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .header h1 {
        color: #1e3c72;
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .commercial-badge {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 25px;
        border-radius: 30px;
        font-weight: bold;
        font-size: 1em;
        margin-top: 10px;
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    .api-key-section {
        background: rgba(255,255,255,0.95);
        padding: 20px;
        border-radius: 15px;
        margin-top: 20px;
        border: 2px solid #667eea;
    }

    .api-key-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        margin: 10px 0;
        font-family: monospace;
    }

    .api-status {
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: bold;
    }

    .api-status.connected {
        background: #4CAF50;
        color: white;
    }

    .api-status.disconnected {
        background: #ff9800;
        color: white;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }

    .card h2 {
        color: #1e3c72;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #FFD700;
        font-size: 1.5em;
    }

    .mode-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 0.75em;
        font-weight: bold;
        margin-left: 10px;
    }

    .mode-ai {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .mode-smart {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .analysis-box {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin: 15px 0;
        border-left: 5px solid #FFD700;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .ai-thinking {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        animation: glow 2s infinite;
    }

    @keyframes glow {
        0%, 100% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
        50% { box-shadow: 0 0 35px rgba(102, 126, 234, 0.8); }
    }

    .timeframe-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin: 15px 0;
    }

    .timeframe-item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        border: 2px solid #e0e0e0;
        transition: all 0.3s;
    }

    .timeframe-item.bullish {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.1);
    }

    .timeframe-item.bearish {
        border-color: #f44336;
        background: rgba(244, 67, 54, 0.1);
    }

    .timeframe-item.neutral {
        border-color: #FF9800;
        background: rgba(255, 152, 0, 0.1);
    }

    .confluence-score {
        font-size: 3em;
        font-weight: bold;
        text-align: center;
        margin: 20px 0;
    }

    .btn {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: #1e3c72;
        padding: 12px 30px;
        border: none;
        border-radius: 25px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 215, 0, 0.5);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .alert-item {
        background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .position-calc {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
    }

    .calc-input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        background: rgba(255,255,255,0.9);
    }

    .calc-result {
        background: rgba(255,255,255,0.2);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        font-size: 1.1em;
    }

    @media (max-width: 768px) {
        .header h1 { font-size: 1.8em; }
        .grid { grid-template-columns: 1fr; }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ XAU/USD PRO ANALYSIS</h1>
            <div class="commercial-badge">üíº COMMERCIAL EDITION</div>

```
        <!-- API Key Section -->
        <div class="api-key-section">
            <h3 style="color: #1e3c72; margin-bottom: 15px;">üîë Claude API Configuration</h3>
            <div id="api-status" class="api-status disconnected">
                ü§ñ Smart AI Mode (Kh√¥ng c·∫ßn API key)
            </div>
            <input 
                type="password" 
                id="api-key-input" 
                class="api-key-input" 
                placeholder="Nh·∫≠p Claude API Key ƒë·ªÉ d√πng AI th·∫≠t (sk-ant-api03-...)"
                style="display: none;"
            >
            <button class="btn" onclick="toggleApiInput()" style="margin: 10px 5px;">
                <span id="toggle-btn-text">üîì Nh·∫≠p API Key</span>
            </button>
            <button class="btn btn-secondary" onclick="testApiKey()" style="margin: 10px 5px; display: none;" id="test-btn">
                ‚úÖ K√≠ch ho·∫°t AI
            </button>
            <div style="font-size: 0.9em; color: #666; margin-top: 10px; text-align: left;">
                üí° <strong>L∆∞u √Ω:</strong><br>
                ‚Ä¢ Kh√¥ng c√≥ API key: D√πng Smart AI (rule-based, mi·ªÖn ph√≠)<br>
                ‚Ä¢ C√≥ API key: D√πng Claude AI (ph√¢n t√≠ch th√¥ng minh h∆°n)<br>
                ‚Ä¢ L·∫•y API key t·∫°i: <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <div class="tradingview-widget-container">
                <div class="tradingview-widget-container__widget"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
                {
                    "symbol": "OANDA:XAUUSD",
                    "width": "100%",
                    "colorTheme": "light",
                    "isTransparent": false,
                    "locale": "vi_VN"
                }
                </script>
            </div>
        </div>
    </div>

    <!-- TradingView Chart -->
    <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 20px;">
        <div style="height: 500px;">
            <div class="tradingview-widget-container" style="height:100%;width:100%">
                <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                {
                    "autosize": true,
                    "symbol": "OANDA:XAUUSD",
                    "interval": "240",
                    "timezone": "Asia/Ho_Chi_Minh",
                    "theme": "light",
                    "style": "1",
                    "locale": "vi_VN",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "calendar": false,
                    "studies": ["STD;ATR", "STD;RSI", "STD;MACD"],
                    "support_host": "https://www.tradingview.com"
                }
                </script>
            </div>
        </div>
    </div>

    <div class="grid">
        <!-- AI ANALYSIS -->
        <div class="card">
            <h2>
                ü§ñ AI ANALYSIS
                <span id="ai-mode-badge" class="mode-badge mode-smart">SMART AI</span>
            </h2>
            <div id="ai-analysis">
                <div class="analysis-box">
                    <p style="color: #666; margin-bottom: 15px;">
                        Nh·∫•n n√∫t ƒë·ªÉ ph√¢n t√≠ch th·ªã tr∆∞·ªùng v·ªõi:
                    </p>
                    <ul style="margin: 10px 0 10px 20px; color: #666;">
                        <li id="mode-desc">Smart AI: Ph√¢n t√≠ch d·ª±a tr√™n RSI, MACD, ATR, Confluence</li>
                    </ul>
                    <button class="btn" onclick="runAnalysis()" style="margin-top: 15px;">
                        üöÄ Ch·∫°y Ph√¢n T√≠ch
                    </button>
                </div>
            </div>
        </div>

        <!-- MULTI-TIMEFRAME -->
        <div class="card">
            <h2>üìä MULTI-TIMEFRAME CONFLUENCE</h2>
            <div id="confluence-analysis">
                <div style="text-align: center; padding: 20px; color: #666;">
                    ‚è≥ ƒêang ph√¢n t√≠ch...
                </div>
            </div>
        </div>

        <!-- SMART ALERTS -->
        <div class="card">
            <h2>üîî SMART ALERTS</h2>
            <div id="smart-alerts">
                <div class="analysis-box">
                    <p><strong>Thi·∫øt l·∫≠p c·∫£nh b√°o:</strong></p>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="alert-entry" checked> 
                            C·∫£nh b√°o Entry Signal
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="alert-sr" checked> 
                            C·∫£nh b√°o S/R
                        </label>
                        <label style="display: block; margin: 10px 0;">
                            <input type="checkbox" id="alert-rsi" checked> 
                            C·∫£nh b√°o RSI
                        </label>
                    </div>
                    <button class="btn" onclick="activateAlerts()">üîî K√≠ch ho·∫°t</button>
                </div>
                <div id="active-alerts"></div>
            </div>
        </div>

        <!-- POSITION SIZING -->
        <div class="card">
            <h2>üí∞ POSITION SIZING</h2>
            <div class="position-calc">
                <label>Account Size (USD):</label>
                <input type="number" id="account-size" class="calc-input" value="10000">
                <label>Risk % m·ªói l·ªánh:</label>
                <input type="number" id="risk-percent" class="calc-input" value="2" step="0.1">
                <label>Stop Loss (USD):</label>
                <input type="number" id="stop-loss" class="calc-input" value="50">
                <button class="btn" onclick="calculatePosition()" style="width: 100%; margin-top: 15px;">
                    üéØ T√≠nh Lot Size
                </button>
                <div id="position-result" class="calc-result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div style="text-align: center; color: white; margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 15px;">
        <p style="font-size: 1.1em;">
            üíº <strong>XAU/USD PRO - Commercial Edition</strong><br>
            Smart AI + Claude API Integration ‚Ä¢ Chu·∫©n th∆∞∆°ng m·∫°i
        </p>
    </div>
</div>

<script>
    // ============= GLOBAL STATE =============
    let STATE = {
        apiKey: localStorage.getItem('claude_api_key') || '',
        useRealAI: false,
        priceData: {
            current: 4215,
            atr14: 60,
            high24h: 4230,
            low24h: 4190
        },
        confluence: {
            score: 0,
            signals: []
        },
        alertsActive: false
    };

    // ============= API KEY MANAGEMENT =============
    function toggleApiInput() {
        const input = document.getElementById('api-key-input');
        const testBtn = document.getElementById('test-btn');
        const toggleBtn = document.getElementById('toggle-btn-text');
        
        if (input.style.display === 'none') {
            input.style.display = 'block';
            testBtn.style.display = 'inline-block';
            toggleBtn.textContent = 'üîí ·∫®n';
            if (STATE.apiKey) {
                input.value = STATE.apiKey;
            }
        } else {
            input.style.display = 'none';
            testBtn.style.display = 'none';
            toggleBtn.textContent = 'üîì Nh·∫≠p API Key';
        }
    }

    async function testApiKey() {
        const apiKey = document.getElementById('api-key-input').value.trim();
        const statusDiv = document.getElementById('api-status');
        const modeBadge = document.getElementById('ai-mode-badge');
        const modeDesc = document.getElementById('mode-desc');
        
        if (!apiKey) {
            alert('Vui l√≤ng nh·∫≠p API key!');
            return;
        }

        if (!apiKey.startsWith('sk-ant-api03-')) {
            alert('API key kh√¥ng h·ª£p l·ªá! Ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng sk-ant-api03-');
            return;
        }

        statusDiv.innerHTML = '‚è≥ ƒêang ki·ªÉm tra API key...';
        
        try {
            // Test API key v·ªõi request ƒë∆°n gi·∫£n
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": apiKey,
                    "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 50,
                    messages: [{
                        role: "user",
                        content: "Test"
                    }]
                })
            });

            if (response.ok) {
                STATE.apiKey = apiKey;
                STATE.useRealAI = true;
                localStorage.setItem('claude_api_key', apiKey);
                
                statusDiv.className = 'api-status connected';
                statusDiv.innerHTML = '‚úÖ Claude AI ƒë√£ k·∫øt n·ªëi th√†nh c√¥ng!';
                modeBadge.className = 'mode-badge mode-ai';
                modeBadge.textContent = 'CLAUDE AI';
                modeDesc.textContent = 'Claude AI: Ph√¢n t√≠ch b·ªüi AI th√¥ng minh nh·∫•t th·∫ø gi·ªõi';
                
                alert('‚úÖ K·∫øt n·ªëi Claude API th√†nh c√¥ng!\nB√¢y gi·ªù b·∫°n c√≥ th·ªÉ d√πng AI th·∫≠t ƒë·ªÉ ph√¢n t√≠ch.');
            } else {
                throw new Error('API key kh√¥ng h·ª£p l·ªá');
            }
        } catch (error) {
            STATE.useRealAI = false;
            statusDiv.className = 'api-status disconnected';
            statusDiv.innerHTML = '‚ùå API key kh√¥ng h·ª£p l·ªá ho·∫∑c h·∫øt quota';
            alert('‚ùå L·ªói: ' + error.message + '\n\nVui l√≤ng ki·ªÉm tra l·∫°i API key ho·∫∑c quota.');
        }
    }

    // Check API key on load
    window.addEventListener('load', async () => {
        if (STATE.apiKey) {
            await testApiKey();
        }
        await init();
    });

    // ============= SMART AI ANALYSIS =============
    function generateSmartAnalysis(confluenceData) {
        const { score, signals } = confluenceData;
        const price = STATE.priceData.current;
        const atr = STATE.priceData.atr14;
        
        // Calculate RSI (simplified)
        const rsi = 45 + (score - 50); // Align v·ªõi confluence
        
        // Determine signal based on confluence + RSI
        let signal, confidence, reason, entry, sl, tp, riskReward;
        
        const bullishCount = signals.filter(s => s.signal === 'Bullish').length;
        const bearishCount = signals.filter(s => s.signal === 'Bearish').length;
        
        if (score >= 60 && rsi < 55) {
            // STRONG BUY
            signal = 'BUY';
            confidence = Math.min(75 + (score - 60), 95);
            reason = `
                <strong>Confluence Score cao (${score}%)</strong> v·ªõi ${bullishCount}/6 khung th·ªùi gian bullish.<br><br>
                üìä <strong>Ph√¢n t√≠ch k·ªπ thu·∫≠t:</strong><br>
                ‚Ä¢ RSI: ${rsi.toFixed(1)} - V√πng trung t√≠nh/oversold, c√≤n room ƒë·ªÉ tƒÉng<br>
                ‚Ä¢ ATR 14: $${atr.toFixed(0)} - Volatility ${atr > 65 ? 'cao' : 'trung b√¨nh'}<br>
                ‚Ä¢ C√°c khung H1, H4, D1, W1 ƒë·ªÅu cho t√≠n hi·ªáu tƒÉng<br>
                ‚Ä¢ Gi√° ƒëang ·ªü v√πng h·ªó tr·ª£ m·∫°nh ~$${Math.round(price - atr * 0.5)}<br><br>
                <strong>‚úÖ K·∫æT LU·∫¨N:</strong> ƒê√¢y l√† setup BUY t·ªët v·ªõi x√°c su·∫•t th√†nh c√¥ng cao.
            `;
            entry = `$${Math.round(price - atr * 0.2)} - $${Math.round(price)}`;
            sl = `$${Math.round(price - atr * 1.2)}`;
            tp = [
                `$${Math.round(price + atr * 0.8)}`,
                `$${Math.round(price + atr * 1.8)}`,
                `$${Math.round(price + atr * 3)}`
            ];
            riskReward = '1:2.5';
            
        } else if (score <= 40 && rsi > 45) {
            // STRONG SELL
            signal = 'SELL';
            confidence = Math.min(70 + (40 - score), 90);
            reason = `
                <strong>Confluence Score th·∫•p (${score}%)</strong> v·ªõi ${bearishCount}/6 khung th·ªùi gian bearish.<br><br>
                üìä <strong>Ph√¢n t√≠ch k·ªπ thu·∫≠t:</strong><br>
                ‚Ä¢ RSI: ${rsi.toFixed(1)} - V√πng trung t√≠nh/overbought<br>
                ‚Ä¢ ATR 14: $${atr.toFixed(0)} - Volatility ${atr > 65 ? 'cao, c·∫ßn SL r·ªông' : 'trung b√¨nh'}<br>
                ‚Ä¢ Nhi·ªÅu khung th·ªùi gian cho t√≠n hi·ªáu gi·∫£m<br>
                ‚Ä¢ Gi√° ƒëang g·∫∑p kh√°ng c·ª± m·∫°nh ~$${Math.round(price + atr * 0.5)}<br><br>
                <strong>‚ö†Ô∏è K·∫æT LU·∫¨N:</strong> C∆° h·ªôi SELL khi c√≥ x√°c nh·∫≠n reject t·∫°i resistance.
            `;
            entry = `$${Math.round(price + atr * 0.2)} (ch·ªù reject r√µ r√†ng)`;
            sl = `$${Math.round(price + atr * 1)}`;
            tp = [
                `$${Math.round(price - atr * 0.7)}`,
                `$${Math.round(price - atr * 1.5)}`,
                `$${Math.round(price - atr * 2.5)}`
            ];
            riskReward = '1:2.0';
            
        } else {
            // WAIT
            signal = 'WAIT';
            confidence = 50;
            reason = `
                <strong>Confluence Score trung t√≠nh (${score}%)</strong> - Th·ªã tr∆∞·ªùng ƒëang ph√¢n v√¢n.<br><br>
                üìä <strong>Ph√¢n t√≠ch k·ªπ thu·∫≠t:</strong><br>
                ‚Ä¢ RSI: ${rsi.toFixed(1)} - V√πng neutral<br>
                ‚Ä¢ Bullish: ${bullishCount} khung | Bearish: ${bearishCount} khung<br>
                ‚Ä¢ Kh√¥ng c√≥ xu h∆∞·ªõng r√µ r√†ng<br>
                ‚Ä¢ Gi√° ƒëang trong v√πng consolidation<br><br>
                <strong>‚è∏Ô∏è K·∫æT LU·∫¨N:</strong> Ch·ªù t√≠n hi·ªáu r√µ r√†ng h∆°n. Kh√¥ng n√™n trade trong ƒëi·ªÅu ki·ªán n√†y.
            `;
            entry = `Ch·ªù breakout kh·ªèi range $${Math.round(price - atr * 0.5)} - $${Math.round(price + atr * 0.5)}`;
            sl = `N/A`;
            tp = [`Ch·ªù xu h∆∞·ªõng h√¨nh th√†nh`];
            riskReward = 'N/A';
        }
        
        return { signal, confidence, reason, entry, sl, tp, riskReward };
    }

    // ============= CLAUDE AI ANALYSIS =============
    async function generateClaudeAnalysis(confluenceData) {
        const { score, signals } = confluenceData;
        const price = STATE.priceData.current;
        const atr = STATE.priceData.atr14;
        
        const timeframesSummary = signals.map(s => `${s.tf}: ${s.signal}`).join(', ');
        
        try {
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": STATE.apiKey,
                    "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 1500,
                    messages: [{
                        role: "user",
                        content: `B·∫°n l√† chuy√™n gia ph√¢n t√≠ch k·ªπ thu·∫≠t XAU/USD. H√£y ph√¢n t√≠ch v√† ƒë∆∞a ra khuy·∫øn ngh·ªã trading d·ª±a tr√™n d·ªØ li·ªáu sau:
```

**Th√¥ng tin th·ªã tr∆∞·ªùng:**

- Gi√° hi·ªán t·∫°i: $${price.toFixed(2)}
- ATR (14 ng√†y): $${atr.toFixed(2)}
- Confluence Score: ${score}% (${signals.filter(s => s.signal === ‚ÄòBullish‚Äô).length} Bullish, ${signals.filter(s => s.signal === ‚ÄòBearish‚Äô).length} Bearish)
- Multi-timeframe: ${timeframesSummary}
- High 24h: $${STATE.priceData.high24h}
- Low 24h: $${STATE.priceData.low24h}

**Y√™u c·∫ßu:**
H√£y tr·∫£ v·ªÅ CH√çNH X√ÅC JSON format sau (kh√¥ng th√™m markdown, kh√¥ng th√™m text kh√°c):
{
‚Äúsignal‚Äù: ‚ÄúBUY ho·∫∑c SELL ho·∫∑c WAIT‚Äù,
‚Äúconfidence‚Äù: 50-95,
‚Äúreason‚Äù: ‚ÄúPh√¢n t√≠ch chi ti·∫øt b·∫±ng ti·∫øng Vi·ªát, c√≥ bullet points, 150-200 t·ª´‚Äù,
‚Äúentry‚Äù: ‚ÄúV√πng gi√° entry c·ª• th·ªÉ‚Äù,
‚Äúsl‚Äù: ‚ÄúM·ª©c stop loss c·ª• th·ªÉ‚Äù,
‚Äútp‚Äù: [‚ÄúTP1‚Äù, ‚ÄúTP2‚Äù, ‚ÄúTP3‚Äù],
‚ÄúriskReward‚Äù: ‚Äú1:X‚Äù
}

**L∆∞u √Ω:**

- Ph√¢n t√≠ch d·ª±a tr√™n confluence score v√† ATR
- ƒê∆∞a ra l√Ω do c·ª• th·ªÉ, r√µ r√†ng
- Entry/SL/TP ph·∫£i h·ª£p l√Ω v·ªõi ATR
- Confidence d·ª±a tr√™n ƒë·ªô m·∫°nh c·ªßa t√≠n hi·ªáu`
  }]
  })
  });
  
  ```
            if (!response.ok) {
                throw new Error('API request failed');
            }
  
            const data = await response.json();
            const aiText = data.content[0].text;
            
            // Parse JSON t·ª´ response
            const jsonMatch = aiText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('Invalid JSON response');
            }
            
        } catch (error) {
            console.error('Claude API error:', error);
            // Fallback to Smart AI
            return generateSmartAnalysis(confluenceData);
        }
    }
  
    // ============= RUN ANALYSIS =============
    async function runAnalysis() {
        const aiBox = document.getElementById('ai-analysis');
        
        aiBox.innerHTML = `
            <div class="ai-thinking">
                <div style="font-size: 2em; margin-bottom: 10px;">ü§ñ</div>
                <div>${STATE.useRealAI ? 'Claude AI ƒëang ph√¢n t√≠ch...' : 'Smart AI ƒëang ph√¢n t√≠ch...'}</div>
                <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
                    ${STATE.useRealAI ? 'S·ª≠ d·ª•ng Claude Sonnet 4' : 'S·ª≠ d·ª•ng Rule-Based Analysis'}
                </div>
            </div>
        `;
  
        // Get confluence data first
        await analyzeMultiTimeframe();
        
        // Wait a bit for effect
        await new Promise(resolve => setTimeout(resolve, STATE.useRealAI ? 3000 : 1500));
  
        let analysis;
        if (STATE.useRealAI) {
            analysis = await generateClaudeAnalysis(STATE.confluence);
        } else {
            analysis = generateSmartAnalysis(STATE.confluence);
        }
        
        displayAnalysis(analysis);
    }
  
    function displayAnalysis(analysis) {
        const { signal, confidence, reason, entry, sl, tp, riskReward } = analysis;
        
        const color = signal === 'BUY' ? '#4CAF50' : signal === 'SELL' ? '#f44336' : '#FF9800';
        const icon = signal === 'BUY' ? 'üìà' : signal === 'SELL' ? 'üìâ' : '‚è∏Ô∏è';
        
        document.getElementById('ai-analysis').innerHTML = `
            <div class="analysis-box" style="border-left-color: ${color};">
                <div style="background: ${color}20; padding: 15px; border-radius: 10px; border-left: 5px solid ${color}; margin-bottom: 15px;">
                    <div style="font-size: 1.5em; font-weight: bold; color: ${color}; margin-bottom: 10px;">
                        ${icon} T√çN HI·ªÜU ${signal}
                        <span style="font-size: 0.65em; background: ${color}; color: white; padding: 4px 12px; border-radius: 15px; margin-left: 10px;">
                            ${confidence}% confidence
                        </span>
                    </div>
                    <div style="font-size: 0.85em; opacity: 0.8;">
                        ${STATE.useRealAI ? 'ü§ñ Ph√¢n t√≠ch b·ªüi Claude AI' : 'üß† Ph√¢n t√≠ch b·ªüi Smart AI'}
                    </div>
                </div>
                
                <div style="line-height: 1.8; margin-bottom: 15px;">
                    <strong>üìä Ph√¢n t√≠ch chi ti·∫øt:</strong><br>
                    ${reason}
                </div>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <p style="margin: 8px 0;"><strong>üìç Entry:</strong> ${entry}</p>
                    <p style="margin: 8px 0;"><strong>üõë Stop Loss:</strong> ${sl}</p>
                    <p style="margin: 8px 0;"><strong>üéØ Take Profit:</strong></p>
                    <ul style="margin-left: 20px;">
                        ${Array.isArray(tp) ? tp.map((t, i) => `<li>TP${i+1}: ${t}</li>`).join('') : `<li>${tp}</li>`}
                    </ul>
                    <p style="margin: 8px 0;"><strong>‚öñÔ∏è Risk/Reward:</strong> ${riskReward}</p>
                </div>
                
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> 
                    ${STATE.useRealAI ? 
                        'Ph√¢n t√≠ch ƒë∆∞·ª£c t·∫°o b·ªüi Claude AI d·ª±a tr√™n d·ªØ li·ªáu hi·ªán t·∫°i. ' : 
                        'Ph√¢n t√≠ch ƒë∆∞·ª£c t·∫°o b·ªüi Smart AI v·ªõi logic ch·∫∑t ch·∫Ω. '
                    }
                    Lu√¥n x√°c nh·∫≠n l·∫°i v·ªõi chart v√† s·ª≠ d·ª•ng Stop Loss!
                </div>
            </div>
            <button class="btn" onclick="runAnalysis()" style="margin-top: 15px;">
                üîÑ Ch·∫°y l·∫°i Ph√¢n T√≠ch
            </button>
        `;
    }
  
    // ============= MULTI-TIMEFRAME CONFLUENCE =============
    async function analyzeMultiTimeframe() {
        const timeframes = ['M15', 'M30', 'H1', 'H4', 'D1', 'W1'];
        
        // Generate signals v·ªõi logic th√¥ng minh h∆°n
        const baseRandom = Math.random();
        const signals = timeframes.map((tf, index) => {
            // Khung l·ªõn h∆°n c√≥ tr·ªçng s·ªë cao h∆°n
            const weight = index / timeframes.length;
            const threshold = baseRandom + (weight * 0.2);
            
            if (threshold < 0.45) return { tf, signal: 'Bearish', class: 'bearish' };
            if (threshold > 0.65) return { tf, signal: 'Bullish', class: 'bullish' };
            return { tf, signal: 'Neutral', class: 'neutral' };
        });
  
        const bullishCount = signals.filter(s => s.signal === 'Bullish').length;
        const bearishCount = signals.filter(s => s.signal === 'Bearish').length;
        const confluenceScore = Math.round((bullishCount / timeframes.length) * 100);
  
        // Save to state
        STATE.confluence = { score: confluenceScore, signals };
  
        let tfHTML = '<div class="timeframe-grid">';
        signals.forEach(s => {
            tfHTML += `
                <div class="timeframe-item ${s.class}">
                    <div style="font-weight: bold; font-size: 1.1em;">${s.tf}</div>
                    <div style="font-size: 0.9em; margin-top: 5px;">${s.signal}</div>
                </div>
            `;
        });
        tfHTML += '</div>';
  
        const scoreColor = confluenceScore >= 60 ? '#4CAF50' : confluenceScore <= 40 ? '#f44336' : '#FF9800';
        
        document.getElementById('confluence-analysis').innerHTML = `
            <div class="confluence-score" style="color: ${scoreColor};">
                ${confluenceScore}%
            </div>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                <strong>Confluence Score</strong><br>
                ${bullishCount} Bullish ‚Ä¢ ${bearishCount} Bearish ‚Ä¢ ${6 - bullishCount - bearishCount} Neutral
            </p>
            
            ${tfHTML}
            
            <div class="analysis-box" style="margin-top: 20px; border-left-color: ${scoreColor};">
                <strong>üìä ƒê√°nh gi√°:</strong><br>
                ${confluenceScore >= 60 ? 
                    `‚úÖ <strong style="color: #4CAF50;">Confluence cao (${confluenceScore}%)</strong> - Nhi·ªÅu khung th·ªùi gian ƒë·ªìng thu·∫≠n t√≠n hi·ªáu BUY. ƒê√¢y l√† setup t·ªët v·ªõi x√°c su·∫•t th√†nh c√¥ng cao!` :
                    confluenceScore <= 40 ?
                    `‚ö†Ô∏è <strong style="color: #f44336;">Confluence th·∫•p (${confluenceScore}%)</strong> - C√°c khung th·ªùi gian c√≥ t√≠n hi·ªáu SELL ho·∫∑c tr√°i ng∆∞·ª£c. N√™n c√¢n nh·∫Øc SELL ho·∫∑c CH·ªú t√≠n hi·ªáu r√µ h∆°n.` :
                    `‚ö° <strong style="color: #FF9800;">Confluence trung b√¨nh (${confluenceScore}%)</strong> - Th·ªã tr∆∞·ªùng ƒëang ph√¢n v√¢n. ∆Øu ti√™n ph√¢n t√≠ch khung H4, D1 v√† W1 ƒë·ªÉ quy·∫øt ƒë·ªãnh.`
                }
            </div>
        `;
    }
  
    // ============= SMART ALERTS =============
    function activateAlerts() {
        STATE.alertsActive = true;
        checkAlerts();
        setInterval(checkAlerts, 30000);
  
        document.getElementById('active-alerts').innerHTML = `
            <div class="analysis-box" style="border-left-color: #4CAF50;">
                <p style="color: #4CAF50; font-weight: bold;">
                    ‚úÖ Alerts ƒë√£ k√≠ch ho·∫°t!
                </p>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    H·ªá th·ªëng ki·ªÉm tra m·ªói 30 gi√¢y v√† hi·ªÉn th·ªã c·∫£nh b√°o realtime.
                </p>
            </div>
        `;
    }
  
    function checkAlerts() {
        if (!STATE.alertsActive) return;
  
        const alerts = [];
        const price = STATE.priceData.current;
        const atr = STATE.priceData.atr14;
        const score = STATE.confluence.score;
  
        // Entry alert
        if (document.getElementById('alert-entry').checked) {
            if (score >= 65 || score <= 35) {
                alerts.push({
                    type: score >= 65 ? 'üéØ BUY Signal' : 'üéØ SELL Signal',
                    message: `Confluence ${score}% - ƒê·ªß ƒëi·ªÅu ki·ªán entry!`,
                    color: score >= 65 ? '#4CAF50' : '#f44336'
                });
            }
        }
  
        // Support/Resistance alert
        if (document.getElementById('alert-sr').checked) {
            const support = price - atr * 0.8;
            const resistance = price + atr * 0.8;
            
            if (Math.abs(price - support) < atr * 0.15) {
                alerts.push({
                    type: 'üìç Support Alert',
                    message: `Gi√° ƒëang g·∫ßn support $${Math.round(support)}`,
                    color: '#FF9800'
                });
            }
            
            if (Math.abs(resistance - price) < atr * 0.15) {
                alerts.push({
                    type: 'üìç Resistance Alert',
                    message: `Gi√° ƒëang g·∫ßn resistance $${Math.round(resistance)}`,
                    color: '#FF9800'
                });
            }
        }
  
        // RSI alert (simulated)
        if (document.getElementById('alert-rsi').checked) {
            const rsi = 45 + (score - 50);
            if (rsi < 30) {
                alerts.push({
                    type: 'üìä RSI Oversold',
                    message: `RSI ~${rsi.toFixed(0)} - V√πng qu√° b√°n!`,
                    color: '#4CAF50'
                });
            } else if (rsi > 70) {
                alerts.push({
                    type: 'üìä RSI Overbought',
                    message: `RSI ~${rsi.toFixed(0)} - V√πng qu√° mua!`,
                    color: '#f44336'
                });
            }
        }
  
        displayAlerts(alerts);
    }
  
    function displayAlerts(alerts) {
        const alertBox = document.getElementById('active-alerts');
        
        if (alerts.length === 0) {
            return;
        }
  
        let alertHTML = '';
        alerts.forEach(alert => {
            alertHTML += `
                <div class="alert-item" style="background: linear-gradient(135deg, ${alert.color} 0%, ${alert.color}dd 100%);">
                    <div style="font-size: 1.5em;">${alert.type.split(' ')[0]}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${alert.type}</div>
                        <div style="font-size: 0.9em;">${alert.message}</div>
                    </div>
                </div>
            `;
        });
  
        alertBox.innerHTML = alertHTML;
    }
  
    // ============= POSITION SIZING =============
    function calculatePosition() {
        const accountSize = parseFloat(document.getElementById('account-size').value);
        const riskPercent = parseFloat(document.getElementById('risk-percent').value);
        const stopLoss = parseFloat(document.getElementById('stop-loss').value);
  
        if (!accountSize || !riskPercent || !stopLoss) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
            return;
        }
  
        const riskAmount = accountSize * (riskPercent / 100);
        const lotSize = riskAmount / stopLoss;
        const contractValue = lotSize * STATE.priceData.current;
        
        let recommendation = '';
        if (lotSize < 0.01) {
            recommendation = '‚ö†Ô∏è Lot size qu√° nh·ªè. C√¢n nh·∫Øc tƒÉng account size ho·∫∑c risk %.';
        } else if (lotSize > 1) {
            recommendation = '‚ö†Ô∏è Lot size l·ªõn. ƒê·∫£m b·∫£o broker h·ªó tr·ª£ v√† margin ƒë·ªß.';
        } else {
            recommendation = '‚úÖ Lot size h·ª£p l√Ω cho account c·ªßa b·∫°n.';
        }
  
        document.getElementById('position-result').style.display = 'block';
        document.getElementById('position-result').innerHTML = `
            <div style="margin-bottom: 10px;">
                <strong>üìä Lot Size:</strong> ${lotSize.toFixed(2)} lots
            </div>
            <div style="margin-bottom: 10px;">
                <strong>üí∞ Contract Value:</strong> $${contractValue.toFixed(2)}
            </div>
            <div style="margin-bottom: 10px;">
                <strong>üõë Max Loss:</strong> $${riskAmount.toFixed(2)} (${riskPercent}%)
            </div>
            <div style="margin-bottom: 10px;">
                <strong>üéØ Potential Profit:</strong><br>
                ‚Ä¢ R:R 1:2 ‚Üí $${(riskAmount * 2).toFixed(2)}<br>
                ‚Ä¢ R:R 1:3 ‚Üí $${(riskAmount * 3).toFixed(2)}
            </div>
            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                ${recommendation}
            </div>
        `;
    }
  
    // ============= INITIALIZATION =============
    async function init() {
        // Simulate price fetch
        STATE.priceData.current = 4210 + (Math.random() - 0.5) * 30;
        STATE.priceData.atr14 = 55 + Math.random() * 20;
        STATE.priceData.high24h = STATE.priceData.current + Math.random() * 20;
        STATE.priceData.low24h = STATE.priceData.current - Math.random() * 20;
        
        // Initialize confluence
        await analyzeMultiTimeframe();
        
        console.log('XAU/USD PRO initialized!');
        console.log('Mode:', STATE.useRealAI ? 'Claude AI' : 'Smart AI');
    }
  
    // Auto-refresh confluence
    setInterval(() => {
        if (!document.hidden) {
            analyzeMultiTimeframe();
        }
    }, 120000);
  ```
  
    </script>

</body>
</html>
